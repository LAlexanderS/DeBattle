{% extends "base.html" %}
{% load get_item %}
{% block title %}Экран | {{ event.title }}{% endblock %}

{% block content %}
<div class="box">
    <h2>Экран трансляции</h2>

    <p><strong>Мероприятие:</strong> {{ event.title }}</p>
    <p><strong>Состояние:</strong> {{ event.state }}</p>
</div>

<div class="box">
    <h3>Туры</h3>
    {% for t in tours %}
      <div style="border:1px solid #333;padding:12px;border-radius:8px;margin-bottom:10px;">
        <strong>Тур №{{ t.number }}</strong> — {{ t.status }}<br>
        Команды:
        <ul>
          {% for team in t.teams.all %}
            <li>{{ team.name }}</li>
          {% empty %}
            <li>пока нет</li>
          {% endfor %}
        </ul>
      </div>
    {% empty %}
      <p>Туров пока нет.</p>
    {% endfor %}
  </div>

  <div class="box">
    <h3>Сцена</h3>
  
    {% if match %}
      <p><strong>Пара:</strong> {{ match.team_a.name }} vs {{ match.team_b.name }}</p>
    {% endif %}
  
    {% if event.state == "PREVIEW" and match %}
      <h4>Превью команд</h4>
      <div style="display:flex;gap:20px;">
        <div style="flex:1;border:1px solid #333;padding:12px;border-radius:8px;">
          <strong>{{ match.team_a.name }}</strong>
          <ul>
            {% for p in match.team_a.participants.all %}
              <li>{{ p.name }} — {{ p.bio }}</li>
            {% endfor %}
          </ul>
        </div>
        <div style="flex:1;border:1px solid #333;padding:12px;border-radius:8px;">
          <strong>{{ match.team_b.name }}</strong>
          <ul>
            {% for p in match.team_b.participants.all %}
              <li>{{ p.name }} — {{ p.bio }}</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    {% endif %}
  
    {% if event.state == "ROUND_ACTIVE" and round %}
      <h4>Раунд {{ round.number }}</h4>
      {% if match.theme %}
        <p><strong>Тема матча:</strong> {{ match.theme.title }}</p>
        {% if match.team_a_position and match.team_b_position %}
          <div style="display:flex;gap:20px;margin-top:15px;">
            <div style="flex:1;border:1px solid #333;padding:12px;border-radius:8px;">
              <strong>{{ match.team_a.name }}</strong>
              <p><strong>Позиция:</strong> 
                {% if match.team_a_position == "FOR" %}За{% elif match.team_a_position == "AGAINST" %}Против{% else %}—{% endif %}
              </p>
            </div>
            <div style="flex:1;border:1px solid #333;padding:12px;border-radius:8px;">
              <strong>{{ match.team_b.name }}</strong>
              <p><strong>Позиция:</strong> 
                {% if match.team_b_position == "FOR" %}За{% elif match.team_b_position == "AGAINST" %}Против{% else %}—{% endif %}
              </p>
            </div>
          </div>
        {% endif %}
      {% else %}
        <p>Сейчас выступают команды выше.</p>
      {% endif %}
    {% endif %}
  
    {% if event.state == "VOTING_OPEN" and round %}
      <h4>Голосование открыто (раунд {{ round.number }})</h4>
      {% if match.theme %}
        <p><strong>Тема матча:</strong> {{ match.theme.title }}</p>
        {% if match.team_a_position and match.team_b_position %}
          <div style="display:flex;gap:20px;margin-top:15px;">
            <div style="flex:1;border:1px solid #333;padding:12px;border-radius:8px;">
              <strong>{{ match.team_a.name }}</strong>
              <p><strong>Позиция:</strong> 
                {% if match.team_a_position == "FOR" %}За{% elif match.team_a_position == "AGAINST" %}Против{% else %}—{% endif %}
              </p>
            </div>
            <div style="flex:1;border:1px solid #333;padding:12px;border-radius:8px;">
              <strong>{{ match.team_b.name }}</strong>
              <p><strong>Позиция:</strong> 
                {% if match.team_b_position == "FOR" %}За{% elif match.team_b_position == "AGAINST" %}Против{% else %}—{% endif %}
              </p>
            </div>
          </div>
        {% endif %}
      {% else %}
        <p>Жюри ставит оценки.</p>
      {% endif %}
    {% endif %}
  
    {% if event.state == "RESULTS" and match %}
        <h4>Результаты (матч)</h4>
    
        {% if not results or results.submitted_jury_count == 0 %}
            <p>Пока никто из жюри не отправил итог.</p>
        {% else %}
            <p><strong>Итог отправили:</strong> {{ results.submitted_jury_count }} судей</p>
        
            <div style="display:flex;gap:20px;margin-top:10px;">
                <div style="flex:1;border:1px solid #333;padding:12px;border-radius:8px;">
                <h3>{{ match.team_a.name }}</h3>
                <p><strong>Итого:</strong> {{ results.team_totals|get_item:match.team_a.id|default:"0" }}</p>
        
                <h4>По критериям</h4>
                <ul>
                    {% for c in criteria %}
                    <li>{{ c.title }}: {{ results.team_by_criterion|get_item:match.team_a.id|get_item:c.id|default:"0" }}</li>
                    {% endfor %}
                </ul>
                </div>
        
                <div style="flex:1;border:1px solid #333;padding:12px;border-radius:8px;">
                <h3>{{ match.team_b.name }}</h3>
                <p><strong>Итого:</strong> {{ results.team_totals|get_item:match.team_b.id|default:"0" }}</p>
        
                <h4>По критериям</h4>
                <ul>
                    {% for c in criteria %}
                    <li>{{ c.title }}: {{ results.team_by_criterion|get_item:match.team_b.id|get_item:c.id|default:"0" }}</li>
                    {% endfor %}
                </ul>
                </div>
            </div>
        {% endif %}
    {% endif %}

    {% if match %}
      <div style="margin-top:20px;border-top:1px solid #333;padding-top:15px;">
        <h4>Раунды матча</h4>
        {% if match.theme %}
          <p><strong>Тема матча:</strong> {{ match.theme.title }}</p>
        {% endif %}
        {% if match.team_a_position and match.team_b_position %}
          <p><strong>Позиции:</strong> {{ match.team_a.name }} — {% if match.team_a_position == "FOR" %}За{% elif match.team_a_position == "AGAINST" %}Против{% endif %}, {{ match.team_b.name }} — {% if match.team_b_position == "FOR" %}За{% elif match.team_b_position == "AGAINST" %}Против{% endif %}</p>
        {% endif %}
        {% for r in match.rounds.all %}
          <div style="border:1px solid #333;padding:12px;border-radius:8px;margin-bottom:10px;">
            <strong>Раунд {{ r.number }}</strong> — {{ r.status }}
          </div>
        {% empty %}
          <p>Раундов пока нет.</p>
        {% endfor %}
      </div>
    {% endif %}

  </div>
  
  <div class="box">
    <h3>Туры</h3>
    {% for t in tours %}
      <div style="border:1px solid #333;padding:12px;border-radius:8px;margin-bottom:10px;">
        <strong>Тур №{{ t.number }}</strong> — {{ t.status }}<br>
        Команды:
        <ul>
          {% for team in t.teams.all %}
            <li>{{ team.name }}</li>
          {% empty %}
            <li>пока нет</li>
          {% endfor %}
        </ul>
      </div>
    {% empty %}
      <p>Туров пока нет.</p>
    {% endfor %}
  </div>
{% endblock %}