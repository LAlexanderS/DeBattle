{% extends "base.html" %}
{% block title %}–ü—É–ª—å—Ç | {{ event.title }}{% endblock %}

{% block content %}
<div class="box">
  <h2>–ü—É–ª—å—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h2>
  <p><strong>{{ event.title }}</strong></p>
  <p><strong>State:</strong> {{ event.state }}</p>

  {% if messages %}
    <div style="margin: 10px 0;">
      {% for m in messages %}
        <div style="padding:10px;border:1px solid #333;border-radius:8px;margin-bottom:8px;">
          {{ m }}
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <h3>–¢–µ–º—ã</h3>
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="reveal_themes">
    <button type="submit">–†–∞—Å–∫—Ä—ã—Ç—å —Ç–µ–º—ã</button>
  </form>

  <h3 style="margin-top:20px;">–¢—É—Ä—ã</h3>
  <p>–í—ã–±–µ—Ä–∏ —Ç–µ–∫—É—â–∏–π —Ç—É—Ä (–æ–±—ã—á–Ω–æ CLOSED/RUNNING):</p>

  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="action" value="set_tour">
    <select name="tour_id">
      {% for t in tours %}
        <option value="{{ t.id }}" {% if event.current_tour_id == t.id %}selected{% endif %}>
          –¢—É—Ä ‚Ññ{{ t.number }} ‚Äî {{ t.status }} (–∫–æ–º–∞–Ω–¥: {{ t.teams.count }})
        </option>
      {% empty %}
        <option value="" disabled>–¢—É—Ä–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</option>
      {% endfor %}
    </select>
    <button type="submit" {% if tours|length == 0 %}disabled{% endif %}>–í—ã–±—Ä–∞—Ç—å</button>
  </form>

  <h3 style="margin-top:20px;">–≠—Ñ–∏—Ä</h3>

  <form method="post" style="margin-top:10px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="start_roulette">
    <button type="submit">üé∞ –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä—É–ª–µ—Ç–∫—É (–≤—ã–±—Ä–∞—Ç—å –ø–∞—Ä—É)</button>
  </form>

  <form method="post" style="margin-top:10px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="start_round">
    <button type="submit">‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å —Å–ª–µ–¥—É—é—â–∏–π —Ä–∞—É–Ω–¥</button>
  </form>

  <form method="post" style="margin-top:10px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="open_voting">
    <button type="submit">üó≥ –û—Ç–∫—Ä—ã—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ</button>
  </form>

  <form method="post" style="margin-top:10px;">
    {% csrf_token %}
    <input type="hidden" name="action" value="close_voting">
    <button type="submit">üîí –ó–∞–∫—Ä—ã—Ç—å –≥–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –∏ –ø–æ–∫–∞–∑–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã</button>
  </form>

  <div style="margin-top:20px;border-top:1px solid #333;padding-top:15px;">
    <h3>–¢–µ–∫—É—â–∏–µ —Å—Ç–∞—Ç—É—Å—ã</h3>

    <p><strong>–¢–µ–∫—É—â–∏–π —Ç—É—Ä:</strong>
      {% if event.current_tour %}
        –¢—É—Ä ‚Ññ{{ event.current_tour.number }} ‚Äî {{ event.current_tour.status }}
      {% else %}
        –Ω–µ—Ç
      {% endif %}
    </p>

    <p><strong>–¢–µ–∫—É—â–∏–π –º–∞—Ç—á:</strong>
      {% if match %}
        {{ match.team_a.name }} vs {{ match.team_b.name }}
      {% else %}
        –Ω–µ—Ç
      {% endif %}
    </p>

    <p><strong>–¢–µ–∫—É—â–∏–π —Ä–∞—É–Ω–¥:</strong> {{ event.current_round_number }}</p>
    <p><strong>–ì–æ–ª–æ—Å–æ–≤–∞–Ω–∏–µ –æ—Ç–∫—Ä—ã—Ç–æ:</strong> {{ event.voting_open }}</p>

    {% if match and match.theme %}
      <div style="margin-top:15px;padding:12px;border:1px solid #333;border-radius:8px;background:#f5f5f5;">
        <h4>–¢–µ–º–∞ –º–∞—Ç—á–∞</h4>
        <p><strong>{{ match.theme.title }}</strong></p>
        {% if match.team_a_position and match.team_b_position %}
          <h4 style="margin-top:15px;">–ü–æ–∑–∏—Ü–∏–∏ –∫–æ–º–∞–Ω–¥ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –≤—Å–µ–≥–æ –º–∞—Ç—á–∞)</h4>
          <div style="display:flex;gap:20px;margin-top:10px;">
            <div style="flex:1;">
              <strong>{{ match.team_a.name }}:</strong> 
              {% if match.team_a_position == "FOR" %}–ó–∞{% elif match.team_a_position == "AGAINST" %}–ü—Ä–æ—Ç–∏–≤{% else %}‚Äî{% endif %}
            </div>
            <div style="flex:1;">
              <strong>{{ match.team_b.name }}:</strong> 
              {% if match.team_b_position == "FOR" %}–ó–∞{% elif match.team_b_position == "AGAINST" %}–ü—Ä–æ—Ç–∏–≤{% else %}‚Äî{% endif %}
            </div>
          </div>
        {% endif %}
        {% if current_round %}
          <h4 style="margin-top:15px;">–¢–µ–∫—É—â–∏–π —Ä–∞—É–Ω–¥ {{ current_round.number }}</h4>
        {% endif %}
      </div>
    {% endif %}

    {% if match and all_rounds %}
      <div style="margin-top:20px;border-top:1px solid #333;padding-top:15px;">
        <h4>–í—Å–µ —Ä–∞—É–Ω–¥—ã –º–∞—Ç—á–∞</h4>
        {% if match.theme %}
          <p><strong>–¢–µ–º–∞ –º–∞—Ç—á–∞:</strong> {{ match.theme.title }}</p>
        {% endif %}
        {% if match.team_a_position and match.team_b_position %}
          <p><strong>–ü–æ–∑–∏—Ü–∏–∏:</strong> {{ match.team_a.name }} ‚Äî {% if match.team_a_position == "FOR" %}–ó–∞{% elif match.team_a_position == "AGAINST" %}–ü—Ä–æ—Ç–∏–≤{% endif %}, {{ match.team_b.name }} ‚Äî {% if match.team_b_position == "FOR" %}–ó–∞{% elif match.team_b_position == "AGAINST" %}–ü—Ä–æ—Ç–∏–≤{% endif %}</p>
        {% endif %}
        {% for r in all_rounds %}
          <div style="border:1px solid #333;padding:12px;border-radius:8px;margin-bottom:10px;">
            <strong>–†–∞—É–Ω–¥ {{ r.number }}</strong> ‚Äî {{ r.status }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    <hr style="border:0;border-top:1px solid #333;margin:15px 0;">

    <h3>–ñ—é—Ä–∏</h3>
    <p><strong>–ò—Ç–æ–≥ –æ—Ç–ø—Ä–∞–≤–∏–ª–æ:</strong> {{ submitted }}/{{ jury_total }}</p>

    <p><strong>–û—Ü–µ–Ω–æ–∫ –≤ —Å–∏—Å—Ç–µ–º–µ:</strong>
      {{ scores_count }}
      {% if expected_scores %}
        /{{ expected_scores }}
      {% endif %}
    </p>
  </div>
</div>
{% endblock %}